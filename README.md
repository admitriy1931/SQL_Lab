**Лабороторные работы по БД**

**LAB2**

Пусть даны 
•	таблица, содержащая типы
измерений (например, влажность, давление и температура воздуха)
•	таблица, содержащая названия гидрометеорологических
станций 
•	таблица, содержащая информацию об измерениях определенных типов, производимых в определенные моменты времени (дата и время) на определенных станциях.

Создать базу данных с указанными таблицами (в таблицах сразу определять первичный ключ, если надо).
Заполнить данными таблицы (в таблице, содержащей информацию об измерениях, должно быть не менее 10 записей)
Пример заполнения таблицы, содержащей типы измерений:
1 Влажность
2 Давление
3 Температура воздуха
4 Температура воды
5 Скорость ветра
6 Излучение солнца

Используя команду ALTER TABLE:

Связать таблицу, содержащую информацию об измерениях, с таблицей типов измерений и с таблицей названий станций.

Добавить в таблицу названий станций новый столбец «адрес», который будет заполняться по умолчанию «Россия, г.».
Добавить в таблицу названий станций новую станцию.

Создать таблицу с наименованиями  единиц измерений (должно быть полное наименование, обозначение). Добавить в нее данные. Пример заполнения таблицы с наименованиями  единиц измерений:
1 Градусы °
2 Метр в секунду м/с
3 Миллиметр ртутного столба мм рт. ст.
4 Паскаль Па
и т.д.

Добавить в таблицу типов измерений новый столбец, связанный с таблицей  наименований единиц измерений. Новый столбец соответственно заполнить с помощью команды UPDATE.


Используя команду SELECT:

1. Выдать упорядоченный список дат, в которые проводились измерения (без повторений).

2. Выдать максимальное и минимальное значение различных измерений.

3. Напишите запрос с подзапросом для получения данных, которые измеряются в градусах. Объяснение. SQL подзапрос — это запрос, вложенный в другой запрос. 
Пример
Рассмотрим таблицу CUSTOMERS, содержащую следующие записи:
 
Теперь давайте выполним следующий подзапрос с инструкцией SELECT.
SELECT * 
  FROM CUSTOMERS 
  WHERE ID IN (SELECT ID 
        FROM CUSTOMERS 
        WHERE SALARY > 4500) ;
В результате мы получим следующее.
 
 
4. Напишите команду SELECT, использующую связанные подзапросы и выполняющую вывод дат (а также код измерения, значение), в которые были минимальное значение измерений.

Пример.
Можно использовать подзапросы, связывающие таблицу со своей собственной копией. Например, надо найти идентификаторы, фамилии и стипендии студентов, получающих стипендию выше средней на курсе, на котором они учатся.
SELECT DISTINCT STUDENT_ID, SURNAME, STIPEND
FROM STUDENT E1
WHERE STIPEND >
(SELECT AVG(STIPEND)
FROM STUDENT E2
WHERE E1.KURS = E2.KURS);

Тот же результат можно получит с помощью следующего запроса:
SELECT DISTINCT STUDENT_ID, SURNAME, STIPEND
FROM STUDENT E1,
(SELECT KURS, AVG(STIPEND) AS AVG_STIPEND
FROM STUDENT E2
GROUP BY E2.KURS) E3
WHERE E1.STIPEND > AVG_STIPEND AND E1.KURS=E3.KURS;

Добавить в таблицу типов измерений запись «Объем осадков».
5. С помощью JOIN выдать информацию тип измерения,  единица измерения. Рассмотреть тот же запрос с помощью WHERE.
Например:
1	SELECT name, addres FROM table1 LEFT JOIN table2 ON table1.user_id=table2.user_id;
2	SELECT table1.name, table1.addres, table2.index FROM table1, table2 WHERE table1.user_id = table2.user_id;


6. Выдать средние значения разных типов измерений ( c единицами измерений) на определенную дату по каждой станции. Заголовки полей итоговых таблиц должны быть на русском языке, даты в виде dd.month.yy(yyyy). 
Пример:	
Дата	Станция	ТипИзмерения	СреднееЗначение	ЕдиницыИзмерения
22.сентября.2021	Метеогорка	Давление	749.5	миллиметр ртутного столба
20.октября.2021	Станция 1	Давление	750	миллиметр ртутного столба
20.октября.2021	Метеогорка	Температура воздуха	5.5	Градус
25.октября.2021	Станция 1	Влажность	48	Процент


Контрольное задание  
Приведён фрагмент базы фрагмент базы данных «Города и страны», описывающей различные страны, города и языки. База данных состоит из трех таблиц. Таблица «Страны» (код, название, континент, регион, площадь, год получения независимости, население, ОПЖ – ожидаемая продолжительность жизни, ВНД – валовый национальный доход, предыдущее значение ВНД, форма правления, идентификатор столицы). Таблица «Города» (идентификатор, название, код страны, район, население). Таблица «Языки» (код языка, код страны, название, является ли официальным, процент использования в стране). По некоторым значениям данных нет, в этом случае в таблице внесено значение NULL. На рисунке приведена схема базы данных.
 
Создайте таблицы и сделайте импорт данных.

Таблица «Страны»- 3-402.csv
Таблица «Города»- 3-40.csv
Таблица «Языки»- 3-401.csv


Фрагмент программы.

CREATE TABLE [dbo].[S_goroda](
	[Cod] [int] PRIMARY KEY,
	[Name] [nvarchar](50) NULL,
	[Cod_s] [nvarchar](5) NULL,
	[Rayon] [nvarchar](50) NULL,
	[Nasel] [int] NULL
) ON [PRIMARY]

GO
BULK INSERT S_goroda FROM 'D:\3-40.csv'
   WITH (
      FIELDTERMINATOR = ';',
      ROWTERMINATOR = '\n'
);
GO
CREATE TABLE [dbo].[S_lang](
	[Cod] [int] PRIMARY KEY,
	[Name] [nvarchar](50) NULL,
	[Cod_s] [nvarchar](5) NULL,
	[Oficial] [nvarchar](1) NULL,
	[procent] [Decimal] (4,1) NULL
) ON [PRIMARY]

GO
BULK INSERT S_lang FROM 'D:\3-401.csv'
   WITH (
      FIELDTERMINATOR = ';',
      ROWTERMINATOR = '\n'
);
GO
CREATE TABLE [dbo].[S_stran](
	[Cod] [nvarchar](5) PRIMARY KEY,
	[Name] [nvarchar](50) NULL,
	[Continent] [nvarchar](50) NULL,
	[Region] [nvarchar](50) NULL,
	[S] [Decimal] (9,1) NULL,
	[Year] [int] NULL,
	[Nasel] [int] NULL,
	[OPG] [Decimal] (4,1) NULL,
	[VND] [Decimal] (8,1) NULL,
	[VNDpred] [Decimal] (8,1)  NULL,
	[Form] [nvarchar](100) NULL,
	[Cod_st] [int] NULL

) ON [PRIMARY]

GO
BULK INSERT S_stran FROM 'D:\3-402.csv'
   WITH (
      FIELDTERMINATOR = ';',
      ROWTERMINATOR = '\n'
);
GO

Выберите по последней цифре номера вашего студенческого билета вариант задания. 
N 	Задание. 
0 	Используя информацию из приведённой базы данных, определите количество городов, расположенных в странах с населением более 100 000 000.

Определите среднее население городов, расположенных в странах, население столицы которых превышает 1 000 000 человек, а одним из официальных языков является английский (English).
1 	Используя информацию из приведённой базы данных, определите среднее значение населения стран у которых в столице проживает более 100000 человек, но не более 500000.

Определите страну с максимальной площадью среди стран Азии у которых один из официальных языков используют более 70% населения. В ответе запишите название страны.
2 	Используя информацию из приведённой базы данных, определите среднюю площадь стран Южной Америки, в которых население столицы не превышает 150 000. 

Определите, на сколько суммарно изменился ВНД стран у которых население столицы превышает 1 000 000 человек. Для тех стран, у которых нет значения ВНД, принять его равным 0. В ответе укажите модуль полученного значения.
3 	Используя информацию из приведённой базы данных, определите страну с максимальной площадью среди стран Азии у которых один из официальных языков используют более 70% населения. В ответе запишите название страны.

Определите среднее население стран Европы, в которых наиболее популярный официальный язык используют менее 60% населения.
.
4 	Используя информацию из приведённой базы данных, определите среднюю ожидаемую продолжительность жизни тех стран, в которых ВНД увеличился, а население столицы не превышает 500 000 человек. Те страны, у которых нет значения ВНД, не учитывать при подсчете.

Определите количество городов с населением не менее 100 000 человек, которые являются столицами стран в которых распространены несколько языков с процентом более 10 каждый.
5 	Используя информацию из приведённой базы данных, определите количество городов, расположенных в странах с населением более 100 000 000.

Определите наиболее часто встречающуюся форму правления среди стран где хотя бы два официальных языка.
6 	Используя информацию из приведённой базы данных, определите среднее значение населения стран у которых в столице проживает более 100000 человек, но не более 500000

Определите среднее население стран Европы, в которых наиболее популярный официальный язык используют менее 60% населения.

7 	Используя информацию из приведённой базы данных, определите среднюю площадь стран Южной Америки, в которых население столицы не превышает 150 000. 

Определите количество городов с населением не менее 100 000 человек, которые являются столицами стран в которых распространены несколько языков с процентом более 10 каждый.
8 	Используя информацию из приведённой базы данных, определите страну с максимальной площадью среди стран Азии у которых один из официальных языков используют более 70% населения. В ответе запишите название страны.

Определите, на сколько суммарно изменился ВНД стран у которых население столицы превышает 1 000 000 человек. Для тех стран, у которых нет значения ВНД, принять его равным 0. В ответе укажите модуль полученного значения.
9 	Используя информацию из приведённой базы данных, определите среднюю ожидаемую продолжительность жизни тех стран, в которых ВНД увеличился, а население столицы не превышает 500 000 человек. Те страны, у которых нет значения ВНД, не учитывать при подсчете.

Определите среднее население стран Европы, в которых наиболее популярный официальный язык используют менее 60% населения.

**LAB3**
Известны средние цены (в рублях) на некоторые основные продукты питания в некоторых городах России.
(должны быть таблицы: 
наименование продукта (id, продукт, ед.изм)
 города (id, название)
цены (id_города,  id_продукта, цена)
набор продуктов в сумке (id_продукта, количество)
)

Создать функцию, которая определяет, сколько стоит в выбранном городе по названию набор продуктов, например: 2 батона пшеничного хлеба, 3кг картофеля, 1,5кг говядины, 1л подсолнечного масла, который хранится в таблице «набор продуктов в сумке».

Создать функцию, которая для выбранного продукта по названию  выбирает список городов с ценами на продукт, с разностью с максимальной ценой, с разностью с минимальной ценой.

Создать функцию, которая для выбранной суммы денег выбирает  список городов с информацией: хватит денег на набор продуктов, сдача или сколько не хватает.
(Можно воспользоваться Выражением CASE.
Пример:
SELECT   [car], [time], "Направление" =   
      CASE   
         WHEN [city] =  0 THEN 'В город'        
         ELSE 'Из города'  
      END  
FROM [car] 
ORDER BY [car],[time] ; 
)

 (Можно создавать дополнительные процедуры или функции.
Можно создать представления.
Представление — это виртуальная таблица, содержимое которой определяется запросом.
Пример: 
CREATE VIEW hiredate_view  
AS   
SELECT p.FirstName, p.LastName, e.BusinessEntityID, e.HireDate  
FROM HumanResources.Employee e   
JOIN Person.Person AS p ON e.BusinessEntityID = p.BusinessEntityID ;
 )

Выдать похожую таблицу на основании имеющейся базы данных.
Наименование продукта 	Тверь 	Липецк 	Барнаул 
Пшеничный хлеб (батон) 	11 	12 	14 
Молоко (1 литр) 	26 	23 	25 
Картофель (1 кг) 	9 	13 	16 
Сыр (1 кг) 	240 	215 	260 
Мясо (говядина) (1 кг)	260 	280 	300 
Подсолнечное масло (1 литр) 	38 	44 	50 
Здесь есть цель использовать команду PIVOT.
Еще одна цель, чтобы в заголовок таблицы попали все города, но сами в команде не перечисляли.
Т.е. 
SET @gorod= перечисление городов
SET @sql = ' SELECT .. ‘
PIVOT
(
AVG (…)
FOR город IN
(‘+@gorod+’)
) AS pvt’

И дальше
EXEC (@sql)

**LAB4**
На въезде-выезде из города расположено несколько ( >=4) постов ГИБДД.
Там регистрируются все выезжающие и въезжающие автомобили.
Камера считывает гос.номер автомобиля и распознает его. 
В базу данных заносятся только правильные (правильно распознанные). Формат номера должен иметь вид CNNNCCNN или CNNNCCNNN, где C – буква, N – цифра. (Буквы в номере должны иметь одинаковое начертание в латинице и кириллице, а первое трехзначное число должно быть натуральным. Если номер имеет вид CNNNCCNNN,  то первая цифра во втором трехзначном числе может быть только 1,2 или 7).  
В базу также заносится время проезда и направление движения (в город или из города). Автомобиль не может 2 раза подряд въехать или выехать из города (чтобы въехать во второй раз автомобиль должен обязательно выехать).
Эти условия должны отслеживаться ключами, триггерами и ограничениями check. Все типы ограничений должны использоваться.
В скрипте иметь тест на проверку корректной работы ограничений.
Все данные анализируются за одни сутки.
В базе должен быть справочник регионов и коды номеров этих регионов.
 Транзитными автомобилями считаются автомобили, въехавшие через один пост и выехавшие через другой и зарегистрированные в другом регионе. Регион определяется по последнему числу номера, например 74, 174 - Челябинская область. Иногородними автомобилями считаются автомобили, въехавшие и выехавшие через один пост. Местными автомобилями считаются автомобили, выехавшие и вернувшиеся в город и имеющие номера данного региона. Прочие, не попавшие в перечисленные типы.
Предусмотреть, что домашний регион может иметь несколько кодов. (Определять домашний регион по названию, например «Свердловская область»).
Выдать списки транзитных, иногородних, местных автомобилей.
Подсчитать количество прочих автомобилей и количество всего автомобилей.
Выдать список автомобилей: номер, название региона, время въезда, пост ГИБДД въезда, время выезда, пост ГИБДД выезда; упорядочить по названию региона.

Все таблицы в базе должны быть максимально нормализованы.
Продумать и создать необходимые индексы для таблиц.
Результаты запросов представить в виде представлений.

**LAB5**
Выполнить:
1.	Перенести данные из файла «Книга1.xls» в SQL Server.
2.	Подправить, если надо, структуру таблиц.
3.	На основании данных выдать информацию:
a.	Создать функцию: Сколько участников тестирования получили по трем выбранным предметам в сумме более заданного количества баллов? (Например. Сколько участников тестирования получили по русскому языку, физике и математике в сумме более 200 баллов?)
b.	Создать функцию: Каков средний балл по выбранному предмету у участников, которые набрали по другому выбранному предмету более заданного количества баллов? (Например: Каков средний балл по физике у участников, которые набрали по математике более 60 баллов?)
c.	Создать процедуру, которая выводит список участников, получивших хотя бы по двум дисциплинам более заданного количества  баллов. 
Использовать CURSOR.
Вид (примерный): колонки «Участник», «Дисциплины, по которым более  баллов»,
Участник 20 математика, физика
Участник 30 физика, информатика, математика
…
d.	Выдать список с колонками: сумма баллов; количество участников, получивших эту сумму. Упорядочить список в порядке убывания суммы баллов. 
e.	Выдать информацию: округ; дисциплина; средний балл; минимальный балл; максимальный балл; участник, получивший максимальный балл; упорядочить по округу. 
f.	Выдать информацию по минимальной и максимальной сумме баллов по всевозможным трем предметам.
Вид (примерный): колонки «Дисциплины», «Минимальная сумма баллов», «Максимальная сумма баллов»,
Русский язык, математика, физика  100   200
Русский язык, математика, информатика  110   250
…

Пример  Разработать курсор для вывода списка фирм и клиентов из Москвы.
DECLARE  @firm    VARCHAR(50),
         @fam     VARCHAR(50),
         @message VARCHAR(80)
PRINT ' Список клиентов'
DECLARE klient_cursor CURSOR LOCAL FOR
    SELECT Фирма, Фамилия
    FROM Клиент
    WHERE Город='Москва'
    ORDER BY Фирма, Фамилия

OPEN klient_cursor
FETCH NEXT FROM klient_cursor INTO @firm, @fam
WHILE @@FETCH_STATUS=0
BEGIN
    SELECT @message='Клиент '+@fam+
                    ' Фирма '+ @firm
    PRINT @message

-- переход к следующему клиенту--

    FETCH NEXT FROM klient_cursor 
      INTO @firm, @fam
END
CLOSE klient_cursor
DEALLOCATE klient_cursor
